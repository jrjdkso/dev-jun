local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local rootPart = char:WaitForChild("HumanoidRootPart")
local humanoid = char:WaitForChild("Humanoid")
local rightHand = char:FindFirstChild("RightHand")

local ZOMBIE_FOLDER = workspace:WaitForChild("ServerZombies")

local trackingEnabled = false
local scriptActive = true
local bp
local startPositions = {}
local FALL_OFFSET = 5
local currentTarget = nil

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.ResetOnSpawn = false
ScreenGui.IgnoreGuiInset = true
ScreenGui.Parent = player:WaitForChild("PlayerGui")

local Main = Instance.new("Frame")
Main.Size = UDim2.new(0, 140, 0, 70)
Main.Position = UDim2.new(0.5, -70, 0.4, 0)
Main.BackgroundColor3 = Color3.new(0, 0, 0)
Main.Active = true
Main.ZIndex = 10
Main.Visible = true
Main.Parent = ScreenGui

local Title = Instance.new("Frame")
Title.Size = UDim2.new(1, 0, 0, 20)
Title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Title.Active = true
Title.ZIndex = 11
Title.Parent = Main

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -6, 1, 0)
TitleLabel.Position = UDim2.new(0, 3, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "추적 제어"
TitleLabel.TextScaled = true
TitleLabel.TextColor3 = Color3.new(1, 1, 1)
TitleLabel.ZIndex = 12
TitleLabel.Parent = Title

local ToggleBtn = Instance.new("TextButton")
ToggleBtn.Size = UDim2.new(1, -10, 0, 22)
ToggleBtn.Position = UDim2.new(0, 5, 0, 24)
ToggleBtn.BackgroundColor3 = Color3.fromRGB(45,45,45)
ToggleBtn.Text = "추적: OFF"
ToggleBtn.TextScaled = true
ToggleBtn.TextColor3 = Color3.new(1,1,1)
ToggleBtn.ZIndex = 11
ToggleBtn.Parent = Main

local ExitBtn = Instance.new("TextButton")
ExitBtn.Size = UDim2.new(1, -10, 0, 22)
ExitBtn.Position = UDim2.new(0, 5, 0, 48)
ExitBtn.BackgroundColor3 = Color3.fromRGB(45,45,45)
ExitBtn.Text = "종료"
ExitBtn.TextScaled = true
ExitBtn.TextColor3 = Color3.new(1,1,1)
ExitBtn.ZIndex = 11
ExitBtn.Parent = Main

local Mini = Instance.new("TextButton")
Mini.Size = UDim2.new(0, 36, 0, 36)
Mini.Position = UDim2.new(0, 6, 0.5, -18)
Mini.BackgroundColor3 = Color3.fromRGB(40,40,40)
Mini.Text = "☰"
Mini.TextScaled = true
Mini.TextColor3 = Color3.new(1,1,1)
Mini.ZIndex = 20
Mini.Parent = ScreenGui

local dragging = false
local dragStart, startPos

local function beginDrag(input)
    dragging = true
    dragStart = input.Position
    startPos = Main.Position
end

local function endDrag()
    dragging = false
end

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        beginDrag(input)
    end
end)

Title.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        endDrag()
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        Main.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.TouchEnded:Connect(endDrag)

local function getZombieHealth(zombie)
    local hum = zombie:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health or math.huge
end

local function getLowestHealthZombie()
    local lowest, hp = nil, math.huge
    for _, z in pairs(ZOMBIE_FOLDER:GetChildren()) do
        local hrp = z:FindFirstChild("HumanoidRootPart")
        if hrp then
            local h = getZombieHealth(z)
            if h < hp then
                lowest, hp = z, h
            end
        end
    end
    return lowest
end

local function enableBP()
    if not bp then
        bp = Instance.new("BodyPosition")
        bp.MaxForce = Vector3.new(1e6, 1e6, 1e6)
        bp.P = 50000
        bp.D = 500
        bp.Parent = rootPart
    end
end

local function disableBP()
    if bp then
        bp:Destroy()
        bp = nil
    end
end

local function saveStartPosition()
    table.insert(startPositions, rootPart.Position)
end

local function safeReturn()
    disableBP()
    local last = table.remove(startPositions)
    if last then
        humanoid.PlatformStand = false
        rootPart.CFrame = CFrame.new(last)
    end
end

ToggleBtn.MouseButton1Click:Connect(function()
    trackingEnabled = not trackingEnabled
    if trackingEnabled then
        humanoid.PlatformStand = true
        saveStartPosition()
        ToggleBtn.Text = "추적: ON"
    else
        safeReturn()
        ToggleBtn.Text = "추적: OFF"
    end
end)

ExitBtn.MouseButton1Click:Connect(function()
    trackingEnabled = false
    scriptActive = false
    safeReturn()
    Main.Visible = false
end)

Mini.MouseButton1Click:Connect(function()
    Main.Visible = not Main.Visible
end)

RunService.RenderStepped:Connect(function()
    if not scriptActive or not trackingEnabled then
        return
    end

    currentTarget = getLowestHealthZombie()
    if not currentTarget then
        return
    end

    local hrp = currentTarget:FindFirstChild("HumanoidRootPart")
    if not hrp then
        return
    end

    enableBP()
    bp.Position = hrp.Position - Vector3.new(0, 1.5 + FALL_OFFSET, 0)

    rootPart.CFrame = CFrame.new(
        rootPart.Position,
        rootPart.Position + Vector3.new(0, 1, 0)
    )

    if rightHand then
        local weapon = rightHand:FindFirstChildWhichIsA("Model")
            or rightHand:FindFirstChildOfClass("Tool")
        if weapon and weapon.PrimaryPart then
            weapon.PrimaryPart.CFrame =
                CFrame.lookAt(weapon.PrimaryPart.Position, hrp.Position)
        end
    end
end)
